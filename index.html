<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企画部会議 報告資料 SPA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fffbeb; /* Light cream background for the body */
            padding-bottom: 80px; /* Space for the fixed save button */
        }
        .sidebar-link.active, .sub-sidebar-link.active {
            background-color: #0284c7; /* Sky-600 for active sidebar link */
            color: white;
        }
        .sub-sidebar-link {
            padding-left: 2.5rem; /* Indent sub-links */
            font-size: 0.875rem; /* Smaller font for sub-links */
            color: #e5e7eb; /* Lighter text for sub-links (gray-200) */
        }
        .sub-sidebar-link:hover {
            background-color: #0369a1; /* Sky-700 for sub-link hover */
            color: white;
        }
        /* Hide mobile menu button container on medium and larger screens */
        @media (min-width: 768px) {
            #mobile-menu-button-container { display: none; }
        }
        /* Styling for image placeholder containers */
        .image-placeholder-container {
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f8fafc; /* Cool Gray 50 */
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0; /* Cool Gray 200 */
        }
        /* Styling for the area where images will be displayed */
        .image-display-area {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e2e8f0; /* Cool Gray 200 */
            border-radius: 0.375rem;
            min-height: 150px; /* Minimum height for the image area */
            margin-bottom: 0.5rem;
            color: #475569; /* Cool Gray 600 for placeholder text */
            text-align: center;
            overflow: hidden; /* Ensure image stays within rounded corners */
        }
        .image-display-area img {
            width: 100%;
            height: auto;
            max-height: 200px; /* Max height for displayed images on smaller screens */
            object-fit: contain; /* Ensure image fits well, maintaining aspect ratio */
            border-radius: 0.375rem; /* Rounded corners for the image itself */
        }
        /* Sidebar transition for mobile view */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        /* Keyword button styling */
        .keyword-btn {
            background-color: #e0f2fe; /* Sky-100 */
            color: #0c4a6e; /* Sky-800 */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .keyword-btn:hover {
            background-color: #bae6fd; /* Sky-200 */
        }
        .keyword-btn.active-highlight {
            background-color: #0284c7; /* Sky-600 */
            color: white;
        }
        /* Styling for text highlighted by keyword buttons */
        .highlight {
            background-color: #fdba74; /* Orange-300 */
            padding: 0.1em;
            border-radius: 0.2em;
            font-weight: bold; /* Make highlighted text bold for better visibility */
        }
        
        /* Styling for individual clickable sentence parts (optional default styling) */
        .clickable-sentence-part {
            /* No default visual style, but ensures it's an inline element */
        }

        /* Styling for sentence highlighted by click */
        .sentence-highlight {
            background-color: #fef9c3 !important; /* 薄黄色 */
            font-weight: bold !important;
            color: red !important;
        }
        /* Modal overlay for keyword definitions */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50; /* Ensure modal is on top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 500px;
            max-height: 80vh; /* Limit modal height */
            overflow-y: auto; /* Allow scrolling if content is too long */
        }
        /* Title for the "Overall Display" section separator */
        .overall-display-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: #334155; /* Slate-700 */
            padding-top: 2rem;
            padding-bottom: 1rem;
            margin-top: 2rem; /* Space above the title */
            border-top: 1px solid #e2e8f0; /* Slate-200 */
        }
        /* Wrapper for each content section in the "Overall Display" */
        .content-section-wrapper {
            margin-bottom: 1.5rem;
        }
        /* Ensure white background for content sections if not overridden by Tailwind */
        .content-section .bg-white {
            background-color: #ffffff;
        }
        /* Margins for headings within content sections */
        .content-section h3, .content-section h4 { margin-top: 1rem; margin-bottom: 0.5rem; }
        .content-section ul { margin-left: 1.5rem; } /* Indent lists */
        /* Collapsible content area, hidden by default */
        .section-content-collapsible {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #cbd5e1; /* Slate-300 */
        }
        /* Toggle button for collapsible content */
        .toggle-content-btn {
            background-image: linear-gradient(to right, #312e81, #4f46e5); /* Indigo-900 to Indigo-600 gradient */
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* Medium weight */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        .toggle-content-btn:hover {
            background-image: linear-gradient(to right, #3730a3, #5c54e0); /* Indigo-800 to Indigo-500 gradient on hover */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Flex container for section header (title and toggle button) */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        /* Container for contact buttons */
        .contact-buttons-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);
            text-align: center;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }
        /* General styling for contact buttons */
        .contact-btn {
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 9999px; /* Pill shape */
            font-weight: 600;
            transition: background-color 0.2s, box-shadow 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 180px; /* Minimum width for contact buttons */
        }
        .email-contact-btn {
            background-color: #dc2626; /* Red-600 */
        }
        .email-contact-btn:hover {
            background-color: #b91c1c; /* Red-700 */
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4); /* Red shadow on hover */
        }
        .phone-contact-btn {
            background-color: #16a34a; /* Green-600 */
        }
        .phone-contact-btn:hover {
            background-color: #15803d; /* Green-700 */
            box-shadow: 0 2px 8px rgba(22, 163, 74, 0.4); /* Green shadow on hover */
        }
        /* Container for the print button in the sidebar */
        .print-button-container {
            text-align: center;
            margin-top: auto; /* Pushes button to the bottom of the flex container (sidebar) */
            padding: 1rem;
        }
        .print-btn {
            background-color: #57534e; /* Stone-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
            width: 100%; /* Make button full width of its container */
        }
        .print-btn:hover {
            background-color: #44403c; /* Stone-700 */
        }
        /* Styling for action item status select dropdown */
        .action-status-select {
            min-width: 100px; /* Ensure select is not too narrow */
        }
        /* Styling for action item notes textarea */
        .action-notes-input {
            min-height: 40px; /* Minimum height for textarea */
            resize: vertical; /* Allow vertical resizing */
        }

        /* Animation for content blocks */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.8s ease-out forwards; /* Slower animation */
        }

        /* Adjust image display for larger screens */
        @media (min-width: 768px) { /* md breakpoint and up */
            .image-display-area {
                min-height: 250px; /* Increased min-height for the container */
            }
            .image-display-area img {
                max-height: 300px; /* Increased max-height for the image, allowing it to be larger */
            }
        }
       
        /* Accordion Styles for Action Items */
        .accordion-item {
            border: 1px solid #e2e8f0; /* Cool Gray 200 */
            border-radius: 0.5rem;
            overflow: hidden; /* For rounded corners on content */
            margin-bottom: 1rem; /* Space between accordion items */
        }
        .accordion-header {
            background-color: #f8fafc; /* Cool Gray 50 */
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #1e3a8a; /* Indigo-800, slightly adjusted for better contrast */
            transition: background-color 0.2s ease;
        }
        .accordion-header:hover {
            background-color: #e0f2fe; /* Sky-100 */
        }
        .accordion-header .accordion-arrow {
            transition: transform 0.3s ease;
            color: #3b82f6; /* Blue-500 for arrow */
        }
        .accordion-header.active .accordion-arrow {
            transform: rotate(90deg);
        }
        .accordion-content {
            padding: 0; 
            background-color: #ffffff;
            display: none; /* Initially hidden */
            border-top: 1px solid #e2e8f0;
        }
        .accordion-content .action-detail { 
            padding: 1rem; 
            border-bottom: 1px dashed #e2e8f0; 
        }
        .accordion-content .action-detail:last-child {
            border-bottom: none;
        }
        .accordion-content .action-detail-label {
            font-weight: 600;
            color: #4b5563; /* Gray-600 */
            font-size: 0.875rem; /* text-sm */
            margin-bottom: 0.25rem;
        }
        .accordion-content .action-detail-value {
            font-size: 0.875rem; /* text-sm */
            color: #1f2937; /* Gray-800 */
            margin-bottom: 0.5rem; 
        }
        .accordion-content .action-text-value {
            margin-top: 0; 
            margin-bottom: 0.75rem; /* Add some space below the action text */
        }
        .accordion-content .action-field-group {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .accordion-content .action-field-group .action-detail-label {
            margin-right: 0.5rem; /* Space between label and control */
            margin-bottom: 0; /* Reset bottom margin for inline display */
            white-space: nowrap; /* Prevent label from wrapping */
        }
        .accordion-content .action-field-group .action-detail-value {
            flex-grow: 1; /* Allow control to take remaining space */
            margin-bottom: 0; /* Reset bottom margin for inline display */
        }

        .accordion-content .action-detail-value select,
        .accordion-content .action-detail-value textarea,
        .accordion-content .action-detail-value input[type="date"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db; /* Gray-300 */
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .accordion-content .action-detail-value textarea {
            min-height: 60px;
            margin-top: 0; /* Textarea doesn't need top margin if label is removed */
        }

        .audio-guide-container {
            /* Styles are applied via Tailwind classes directly in HTML */
        }
        .audio-shortcut-link {
            display: block;
            padding: 0.5rem 1rem; /* py-2 px-4 */
            margin-bottom: 0.5rem; /* mb-2 */
            border-radius: 0.375rem; /* rounded-md */
            background-color: #1e3a8a; /* Indigo-800 */
            color: #e0f2fe; /* Sky-100 */
            text-align: center;
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        .audio-shortcut-link:hover {
            background-color: #312e81; /* Indigo-900 */
        }
        .open-document-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border: 1px solid transparent;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* medium */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            color: white;
            background-color: #16a34a; /* Green-600 */
            transition: background-color 0.2s ease-in-out;
            text-decoration: none;
        }
        .open-document-btn:hover {
            background-color: #15803d; /* Green-700 */
        }
        .open-document-btn svg {
            margin-right: 0.5rem; /* mr-2 */
        }
        .save-action-items-btn {
             /* Styles applied via Tailwind classes */
        }
        .save-action-items-btn-wrapper {
            /* Styles applied via Tailwind classes */
        }
        #fixed-save-button-container button:disabled {
            background-color: #9ca3af; /* Gray-400 */
            cursor: not-allowed;
        }
        #fixed-save-button-container button:disabled:hover {
            background-color: #9ca3af; /* Gray-400 */
        }


        /* Print-specific styles */
        @media print {
            body {
                background-color: #ffffff !important; 
                background-image: none !important; 
                padding-bottom: 0 !important;
            }
            #sidebar, #mobile-menu-button-container, .toggle-content-btn, .keyword-buttons-area, #keyword-modal, .contact-buttons-container, .print-button-container, .overall-display-title, .sidebar-link h2, .audio-guide-container, .audio-shortcut-link, .open-document-btn, .save-action-items-btn-wrapper, #fixed-save-button-container {
                display: none !important;
            }
            main {
                padding: 1rem !important; 
                margin: 0 !important; 
            }
            .content-section-wrapper {
                margin-bottom: 1rem !important;
                page-break-inside: avoid; 
            }
            .content-section .bg-white {
                box-shadow: none !important; 
                border: 1px solid #e2e8f0 !important; 
                padding: 1rem !important;
                opacity: 1 !important; 
                transform: translateY(0) !important; 
            }
            .section-content-collapsible {
                display: block !important;
                border-top: none !important;
                margin-top: 0.5rem !important;
                padding-top: 0.5rem !important;
            }
            .image-placeholder-container {
                padding: 0.25rem !important;
            }
            .image-display-area {
                min-height: 100px !important;
            }
            .image-display-area img {
                max-height: 150px !important; 
            }
            h1, h2, h3, h4, p, li { 
                color: #000000 !important;
            }
            .clickable-sentence-part.sentence-highlight {
                color: #000000 !important; 
                background-color: transparent !important; 
                font-weight: bold !important; 
            }
            #action_items_list .accordion-item {
                border: none !important;
                margin-bottom: 1rem !important;
                page-break-inside: avoid;
            }
            #action_items_list .accordion-header {
                background-color: transparent !important;
                padding: 0.5rem 0 !important;
                border-bottom: 1px solid #ccc !important;
                color: #000 !important;
            }
            #action_items_list .accordion-header .accordion-arrow {
                display: none !important; 
            }
            #action_items_list .accordion-content {
                display: block !important; 
                padding: 0.5rem 0 0 0 !important;
                border-top: none !important;
            }
             #action_items_list .accordion-content .action-detail {
                padding: 0.25rem 0 !important;
                border-bottom: 1px dotted #eee !important;
            }
            #action_items_list .accordion-content .action-detail:last-child {
                border-bottom: none !important;
            }
            #action_items_list .action-detail-label {
                color: #333 !important;
            }
            #action_items_list .action-detail-value {
                color: #000 !important;
            }
            .action-status-select, .action-notes-input, .deadline-type-select, .deadline-date-input {
                border: 1px solid #ccc !important;
                -webkit-appearance: none; 
                -moz-appearance: none;
                appearance: none;
                padding: 2px;
                background-color: transparent;
            }
            .action-notes-input { min-height: auto !important; }
            .animate-fade-in-up {
                animation: none !important; 
                opacity: 1 !important; 
                transform: translateY(0) !important; 
            }
        }
    </style>
</head>
<body class="text-slate-800">
    <div class="flex flex-col md:flex-row min-h-screen">
        <div id="mobile-menu-button-container" class="md:hidden p-4 bg-slate-800 text-white flex justify-between items-center sticky top-0 z-20">
            <h1 class="text-lg sm:text-xl font-semibold">企画部会議報告</h1>
            <button id="mobile-menu-button" aria-label="メニューを開く">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
        </div>

        <aside id="sidebar" class="w-64 bg-slate-800 text-slate-100 p-4 md:p-6 space-y-2 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-30 md:sticky md:top-0 md:h-screen flex flex-col overflow-y-auto">
            <div class="hidden md:block">
                <h1 class="text-xl xl:text-2xl font-semibold text-white mb-2">企画部会議報告</h1>
                <a href="#" id="audio-guide-shortcut-link" class="audio-shortcut-link">音声ガイドを聴く 🎧</a>
            </div>
            <nav id="main-nav" class="flex-grow mt-4">
                </nav>
            <div class="print-button-container">
                <button id="print-page-btn" class="print-btn">このページを印刷</button>
            </div>
        </aside>

        <main id="main-content-area" class="flex-1 p-4 sm:p-6 md:p-10 overflow-y-auto pt-16 sm:pt-20 md:pt-10">
            </main>
    </div>

    <div id="fixed-save-button-container" class="fixed bottom-0 left-0 right-0 bg-slate-100 p-3 shadow-lg border-t border-slate-300 text-center" style="display: none; z-index: 40;">
        <button id="global-save-action-items-btn"
                class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 save-action-items-btn-js">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -ml-1 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5 2a3 3 0 00-3 3v10a3 3 0 003 3h10a3 3 0 003-3V5a3 3 0 00-3-3H5zm1 4.25A.75.75 0 016.75 6h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 6.25zm0 3.5A.75.75 0 016.75 9.5h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 9.75zm0 3.5A.75.75 0 016.75 13h6.5a.75.75 0 010 1.5h-6.5A.75.75 0 016 13.25z" clip-rule="evenodd" />
            </svg>
            変更を保存
            <span id="global-save-status-message" class="ml-2 text-sm"></span>
        </button>
    </div>


    <div id="all-sections-template" style="display: none;">
        <section id="intro" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-intro-main">1. はじめに</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="audio-guide-container bg-sky-50 p-4 rounded-lg shadow-md mb-4">
                    <h3 class="text-md font-semibold text-sky-700 mb-2">音声ガイド</h3>
                    <audio controls class="w-full" id="main-audio-player">
                        <source src="voice1.mp3" type="audio/mpeg">
                        お使いのブラウザは音声要素をサポートしていません。
                    </audio>
                    <p class="text-xs text-slate-600 mt-1">この資料の概要を音声でお聞きいただけます。</p>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                        <img src="1.jpeg" alt="会議のイメージ 1" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+1.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <div class="keyword-buttons-area mb-4">
                        <button class="keyword-btn" data-keyword="進捗報告" data-definition="各担当業務の進捗状況に関する報告のことです。">進捗報告</button>
                        <button class="keyword-btn" data-keyword="AI技術" data-definition="人工知能（Artificial Intelligence）に関する技術全般を指します。業務効率化や新しい価値創造に活用されます。">AI技術</button>
                        <button class="keyword-btn" data-keyword="連携強化" data-definition="部門間やチーム間の協力関係をより強くし、円滑な業務遂行を目指すことです。">連携強化</button>
                    </div>
                    <div class="text-content-for-highlight">
                        <p class="text-lg leading-relaxed highlightable-text">本日の企画部会議では、各担当業務の進捗報告、課題の共有、そして今後の<strong>アクションプラン</strong>について活発な議論が行われました。特に、<strong>データに基づいた施策改善</strong>、<strong>AI技術</strong>の積極的な活用、そして部門間の<strong>連携強化</strong>が重点的に話し合われました。この資料では、会議の主要な内容を分かりやすくまとめ、今後の活動に繋げていくことを目的としています。</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="abe_share" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-abe_share-main">2. 阿部部長からの共有事項</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                         <img src="2.jpeg" alt="アイデアとAIの融合 イメージ 2" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+2.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <div class="keyword-buttons-area mb-4">
                        <button class="keyword-btn" data-keyword="ミッションステートメント" data-definition="組織や個人が持つべき使命や基本的な価値観を明文化したものです。">ミッションステートメント</button>
                        <button class="keyword-btn" data-keyword="AI技術" data-definition="人工知능（Artificial Intelligence）に関する技術全般を指します。業務効率化や新しい価値創造に活用されます。">AI技術</button>
                        <button class="keyword-btn" data-keyword="価値創造" data-definition="新しい価値を生み出すこと、または既存の価値を高める活動のことです。">価値創造</button>
                        <button class="keyword-btn" data-keyword="Notion" data-definition="ドキュメント作成、タスク管理、データベース構築などが可能な多機能な情報共有ツールです。">Notion</button>
                    </div>
                    <div class="text-content-for-highlight">
                        <p class="mb-4 text-lg highlightable-text">阿部部長より、以下のミッションと現状認識、今後の展望について共有がありました。</p>
                        <div class="mb-6 p-4 bg-sky-50 rounded-md">
                            <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mb-2 highlightable-text" id="sub-abe_share-mission"><strong>ミッションステートメント</strong>の再確認</h3>
                            <p class="italic text-slate-700 highlightable-text">「私たちは、<strong>未開の力</strong>、<strong>価値を創造</strong>し、感謝と愛情をもって人と接し、<strong>感動のシナジー</strong>を作り出す。」</p>
                        </div>
                        <div class="mb-6 p-4 bg-sky-50 rounded-md">
                            <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mb-2 highlightable-text" id="sub-abe_share-issues">現状の取り組みと課題</h3>
                            <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                                <li class="highlightable-text"><strong>AI技術</strong>（チャットボット開発、Liny AI問合せシステム、AI Luca試験運用、AIによるLP量産計画など）の積極的なインプットと活用。</li>
                                <li class="highlightable-text">インプット過多による<strong>アウトプット（成果）</strong>への不安と、その解消に向けた<strong>行動の重要性</strong>。</li>
                                <li class="highlightable-text"><strong>未開拓な価値創造</strong>への挑戦（例：LinyのAIチャットボットによる社内知見の集約）。</li>
                            </ul>
                        </div>
                        <div class="mb-6 p-4 bg-sky-50 rounded-md">
                            <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mb-2 highlightable-text" id="sub-abe_share-expectations">メンバーへの期待と感謝</h3>
                            <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                                <li class="highlightable-text">各メンバーが現場で成果を出し続けていることへの感謝。</li>
                                <li class="highlightable-text">これにより、部長自身が<strong>第二領域（未開拓分野）</strong>へ注力できている現状。</li>
                                <li class="highlightable-text"><strong>Notion活用</strong>による情報整理・効率化の推進。</li>
                            </ul>
                        </div>
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mb-2 highlightable-text" id="sub-abe_share-comments">各メンバーからのコメント</h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text">千早氏: AIチャットボットは便利で良いと感じる。</li>
                            <li class="highlightable-text">渡辺氏: 部長の試行錯誤の重要性に共感。自身のマンパワー不足を認識しており、企画部の取り組みによる業務効率化に期待。</li>
                            <li class="highlightable-text">藤方氏: 部長の「<strong>0→1</strong>」の取り組みを具体化し、価値向上に貢献したい。</li>
                            <li class="highlightable-text">土屋氏: 各自が役割を全うすることでチームとしての成果が出ると認識。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="chihaya_report" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-chihaya_report-main">3-1. 千早 克典 氏</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                        <img src="3.jpeg" alt="バナーデザインとシステム構築 イメージ 3" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+3.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <div class="keyword-buttons-area mb-4">
                        <button class="keyword-btn" data-keyword="LINEバナー" data-definition="LINEプラットフォーム上で表示される広告や告知用の画像のことです。">LINEバナー</button>
                        <button class="keyword-btn" data-keyword="Liny構築" data-definition="LINE公式アカウントの機能を拡張し、マーケティングや顧客管理を自動化・効率化するツール「Liny」のシステム設定やカスタマイズを行うことです。">Liny構築</button>
                        <button class="keyword-btn" data-keyword="効果検証" data-definition="実施した施策やキャンペーンが、どの程度の効果があったかをデータに基づいて分析・評価することです。">効果検証</button>
                        <button class="keyword-btn" data-keyword="A/Bテスト" data-definition="2つ以上の異なるパターンの広告やデザインを用意し、どちらがより高い効果を上げるかを比較検証するテスト手法です。">A/Bテスト</button>
                    </div>
                    <div class="mt-4 mb-4">
                        <a href="2505ti.pdf" target="_blank" class="open-document-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                            </svg>
                            資料を開く
                        </a>
                    </div>
                    <div class="text-content-for-highlight">
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-4 mb-2 highlightable-text" id="sub-chihaya_report-content">報告内容</h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text"><strong>LINEバナー制作</strong> (エアコン、バッテリー、タイヤ、洗車キャンペーン等、計12枚)</li>
                            <li class="highlightable-text"><strong>Liny構築</strong> (つくば支店様 抽選会配信準備、車検リッチタップ自動配信構築)</li>
                            <li class="highlightable-text">デジプリ移行係数集計、移行システム構築</li>
                            <li class="highlightable-text">バナー制作における<strong>AI活用</strong> (素材検索時間の短縮、画像生成)</li>
                        </ul>
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-6 mb-2 highlightable-text" id="sub-chihaya_report-feedback">主なフィードバックとアクション</h3>
                        <div class="grid md:grid-cols-2 gap-4 highlightable-text">
                            <div class="p-4 bg-green-50 rounded-md">
                                <h4 class="text-base sm:text-lg font-semibold text-green-700 mb-1 highlightable-text">良かった点</h4>
                                <ul class="list-disc list-inside text-sm text-green-600 highlightable-text"><li class="highlightable-text">バナー制作時間の<strong>大幅短縮</strong>と<strong>クオリティ向上</strong>。</li></ul>
                            </div>
                            <div class="p-4 bg-red-50 rounded-md">
                                <h4 class="text-base sm:text-lg font-semibold text-red-700 mb-1 highlightable-text">課題・改善点</h4>
                                <ul class="list-disc list-inside text-sm text-red-600 highlightable-text">
                                    <li class="highlightable-text"><strong>効果検証の深化</strong>：作成バナーの具体的成果（タップ率、予約数等）を詳細に追跡・報告。</li>
                                    <li class="highlightable-text"><strong>A/Bテストの徹底</strong>：1施策に対し最低2パターンのデザイン/訴求を用意し比較検証。</li>
                                    <li class="highlightable-text">Liny構築時間の更なる短縮：目標時間を意識し効率化。</li>
                                    <li class="highlightable-text"><strong>漫画LPの改善</strong>：構成、文字量、吹き出しサイズ、訴求内容の明確化。</li>
                                    <li class="highlightable-text"><strong>CTA (Call to Action)</strong> の意識強化：ユーザー行動を促すデザイン追求。</li>
                                </ul>
                            </div>
                        </div>
                        <h4 class="text-base sm:text-lg font-semibold text-sky-700 mt-4 mb-1 highlightable-text" id="sub-chihaya_report-actionitems">次回のアクション</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text">効果検証のフォーマットを確立し、具体的な数値で報告する。</li>
                            <li class="highlightable-text">今後のバナー制作では必ずA/Bテストを実施し、その結果を共有する。</li>
                            <li class="highlightable-text">Liny構築作業の標準作業時間（SOP）の確立と、それに基づく時間管理。</li>
                            <li class="highlightable-text">AIによる画像生成のスキルをさらに高め、業務効率化に繋げる。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="fujikata_report" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-fujikata_report-main">3-2. 藤方 優樹 氏</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                        <img src="4.jpeg" alt="データ分析と戦略立案 イメージ 4" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+4.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <div class="keyword-buttons-area mb-4">
                        <button class="keyword-btn" data-keyword="効果検証" data-definition="実施した施策やキャンペーンが、どの程度の効果があったかをデータに基づいて分析・評価することです。">効果検証</button>
                        <button class="keyword-btn" data-keyword="洗車キャンペーン" data-definition="洗車サービスをお得に利用できる期間限定の販売促進活動のことです。">洗車キャンペーン</button>
                        <button class="keyword-btn" data-keyword="クーポン" data-definition="特定の商品やサービスを割引価格で利用できる券のことです。新規顧客獲得やリピート促進に用いられます。">クーポン</button>
                        <button class="keyword-btn" data-keyword="データ抽出" data-definition="データベースやシステムから特定の条件に合致する情報を取り出すことです。">データ抽出</button>
                    </div>
                    <div class="mt-4 mb-4">
                        <a href="2505fujidata.pdf" target="_blank" class="open-document-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                            </svg>
                            資料を開く
                        </a>
                    </div>
                    <div class="text-content-for-highlight">
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-4 mb-2 highlightable-text" id="sub-fujikata_report-content">報告内容</h3>
                        <h4 class="text-base sm:text-lg font-semibold text-slate-700 mb-1 highlightable-text">4月施策の<strong>効果検証</strong>:</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 ml-4 highlightable-text">
                            <li class="highlightable-text"><strong>洗車キャンペーン</strong>: 手洗い洗車時間変更による予約枠減少が影響し、ネット予約数が前年比減。</li>
                            <li class="highlightable-text">新規顧客向けクーポン: <strong>金額明示型</strong>は効果あり、高単価商品や割引率提示型は効果薄。</li>
                            <li class="highlightable-text">オイル交換キャンペーン: メンテナンスパック加入者増によるピット圧迫が影響し、家内SSで予約減。</li>
                        </ul>
                        <h4 class="text-base sm:text-lg font-semibold text-slate-700 mt-2 mb-1 highlightable-text">制作物・導入ツール:</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 ml-4 highlightable-text">
                            <li class="highlightable-text"><strong>One Team年間実績表</strong>: データ抽出時間の大幅削減。</li>
                            <li class="highlightable-text">ピットロック予約データ抽出フォーム: 効果検証にかかる時間短縮。</li>
                            <li class="highlightable-text">ハラスメント研修テスト問題作成。</li>
                        </ul>
                        <h4 class="text-base sm:text-lg font-semibold text-slate-700 mt-2 mb-1 highlightable-text">進行中の施策:</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 ml-4 highlightable-text">
                            <li class="highlightable-text">デジプリ期間限定ボーナスシステム構築。</li>
                            <li class="highlightable-text"><strong>Liny/Lステップ活用強化</strong>による収益最大化（ファンクラブ構想など）。</li>
                        </ul>
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-6 mb-2 highlightable-text" id="sub-fujikata_report-feedback">主なフィードバックとアクション</h3>
                        <div class="grid md:grid-cols-2 gap-4 highlightable-text">
                            <div class="p-4 bg-green-50 rounded-md">
                                <h4 class="text-base sm:text-lg font-semibold text-green-700 mb-1 highlightable-text">良かった点</h4>
                                <ul class="list-disc list-inside text-sm text-green-600 highlightable-text">
                                    <li class="highlightable-text">データ集計・分析ツールの作成による業務効率化。</li>
                                    <li class="highlightable-text">詳細なデータに基づく分析。</li>
                                </ul>
                            </div>
                            <div class="p-4 bg-red-50 rounded-md">
                                <h4 class="text-base sm:text-lg font-semibold text-red-700 mb-1 highlightable-text">課題・改善点</h4>
                                <ul class="list-disc list-inside text-sm text-red-600 highlightable-text">
                                    <li class="highlightable-text"><strong>分析の抽象化レベル向上</strong>：データから安易な結論を導かず、多角的な視点（<strong>現場ヒアリング</strong>、AI活用等）で要因を深掘りし<strong>本質的課題</strong>を特定。</li>
                                    <li class="highlightable-text">現場ヒアリングの徹底：数値データで見えない現場状況を把握し分析に反映。</li>
                                    <li class="highlightable-text">データ解釈の客観性：主観だけでなく客観的データと論理に基づいた解釈を心がける。</li>
                                </ul>
                            </div>
                        </div>
                        <h4 class="text-base sm:text-lg font-semibold text-sky-700 mt-4 mb-1 highlightable-text" id="sub-fujikata_report-actionitems">次回のアクション</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text">今後の効果検証では、必ず現場ヒアリングを実施し、その内容を分析に加味する。</li>
                            <li class="highlightable-text">AI（ChatGPTなど）を活用し、データ分析の視点や抽象化の訓練を行う。</li>
                            <li class="highlightable-text">One Team年間実績表に累計データを追加し、視認性を向上させる。</li>
                            <li class="highlightable-text">家内SSのLiny予約システム刷新効果を明確に示せるようデータ収集・分析方法を再検討する。</li>
                            <li class="highlightable-text">永井石油様向けLinyシステム構築を完了させる。</li>
                            <li class="highlightable-text">小出氏からのデジプリ販売者特定依頼に対応する。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="watanabe_a_report" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-watanabe_a_report-main">3-3. 篤史 渡辺 氏</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                        <img src="5.jpeg" alt="名刺・QRとコミュニケーション イメージ 5" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+5.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <div class="mt-4 mb-4">
                        <a href="2505wata.pdf" target="_blank" class="open-document-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                            </svg>
                            資料を開く
                        </a>
                    </div>
                    <div class="text-content-for-highlight">
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-4 mb-2 highlightable-text" id="sub-watanabe_a_report-content">報告内容</h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text"><strong>タイヤ獲得促進</strong>を目的とした<strong>名刺サイズのQRコード付きツール</strong>の制作進捗。
                                <ul class="list-circle list-inside ml-4 highlightable-text">
                                    <li class="highlightable-text">スタッフが顧客に配布しやすいツールを目指す。</li>
                                    <li class="highlightable-text">QRコード読み込みで、LINEのタイヤ割引情報ページへ誘導。</li>
                                    <li class="highlightable-text">デザイン案を複数作成し、所長やスタッフから意見聴取中。</li>
                                </ul>
                            </li>
                        </ul>
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-6 mb-2 highlightable-text" id="sub-watanabe_a_report-feedback">主なフィードバックとアクション</h3>
                        <div class="grid md:grid-cols-2 gap-4 highlightable-text">
                            <div class="p-4 bg-green-50 rounded-md">
                                <h4 class="text-base sm:text-lg font-semibold text-green-700 mb-1 highlightable-text">良かった点</h4>
                                <ul class="list-disc list-inside text-sm text-green-600 highlightable-text"><li class="highlightable-text">スタッフの意見を取り入れ、現場で活用しやすいツールを目指す姿勢。</li></ul>
                            </div>
                            <div class="p-4 bg-red-50 rounded-md">
                                <h4 class="text-base sm:text-lg font-semibold text-red-700 mb-1 highlightable-text">課題・改善点</h4>
                                <ul class="list-disc list-inside text-sm text-red-600 highlightable-text">
                                    <li class="highlightable-text"><strong>デザイン改善</strong>（視認性、情報伝達の明確化、色使い、QRコード配置/サイズ）。</li>
                                    <li class="highlightable-text"><strong>効果測定の実施</strong>（配布枚数、QR読込数、読込後アクション記録・分析、<strong>A/Bテスト</strong>）。</li>
                                    <li class="highlightable-text">報告フォーマット確立（目的・施策・効果検証の構成）。</li>
                                </ul>
                            </div>
                        </div>
                        <h4 class="text-base sm:text-lg font-semibold text-sky-700 mt-4 mb-1 highlightable-text" id="sub-watanabe_a_report-actionitems">次回のアクション</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text">提示されたデザイン案について、フォントや配色を再検討し、視認性を向上させる。</li>
                            <li class="highlightable-text">名刺サイズという限られたスペースで最大限の効果を出すため、掲載情報を精査し、キャッチーなコピーを検討する。</li>
                            <li class="highlightable-text">QRコード読み込み後のランディングページの内容と連動させ、一貫した顧客体験を提供する。</li>
                            <li class="highlightable-text">A/Bテストの計画を立て、具体的なKPIを設定する。</li>
                            <li class="highlightable-text">大石氏との店舗作りに関する知見共有の時間を調整する。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="tsuchiya_report" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-tsuchiya_report-main">3-4. Takuro Tsuchiya 氏</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                        <img src="6.jpeg" alt="チームワークと目標達成 イメージ 6" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+6.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <div class="mt-4 mb-4">
                        <a href="2505tudata.pdf" target="_blank" class="open-document-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                            </svg>
                            資料を開く
                        </a>
                    </div>
                    <div class="text-content-for-highlight">
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-4 mb-2 highlightable-text" id="sub-tsuchiya_report-content">報告内容</h3>
                        <h4 class="text-base sm:text-lg font-semibold text-slate-700 mb-1 highlightable-text">社長への<strong>隔月報告（初回）の骨子</strong>:</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 ml-4 highlightable-text">
                            <li class="highlightable-text">今年度の役割: 市長・部長・統括の思いを現場に繋ぐ「<strong>橋渡し役</strong>」。</li>
                            <li class="highlightable-text">テーマ: <strong>自己変革から組織変革へ</strong>。</li>
                            <li class="highlightable-text">ミッション: 1. <strong>組織変革</strong>（One Team導入）、2. <strong>洗車開拓強化</strong>。</li>
                        </ul>
                        <h4 class="text-base sm:text-lg font-semibold text-slate-700 mt-2 mb-1 highlightable-text">4月実績報告（主なもの）:</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 ml-4 highlightable-text">
                            <li class="highlightable-text">洗車台数・利用率: 目標未達。対策としてイベント開催、楽天洗車活用。</li>
                            <li class="highlightable-text">洗車受注単価: 目標達成。</li>
                            <li class="highlightable-text">プリカ商品合計: 前年比90%。</li>
                            <li class="highlightable-text"><strong>タイヤ販売本数</strong>: 前年比134%（アイコン含めると515%）と好調。</li>
                        </ul>
                        <h4 class="text-base sm:text-lg font-semibold text-slate-700 mt-2 mb-1 highlightable-text">若手所長チーム「<strong>つむじ風</strong>」発足:</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 ml-4 highlightable-text">
                            <li class="highlightable-text">目的: <strong>次世代リーダー育成</strong>、圧倒的な熱量と成長。</li>
                            <li class="highlightable-text">活動計画: 6月にタイヤボールイベント開催など。</li>
                        </ul>
                        <h4 class="text-base sm:text-lg font-semibold text-slate-700 mt-2 mb-1 highlightable-text">企画部メンバーへの期待:</h4>
                        <p class="text-slate-700 ml-4 highlightable-text">各分野のプロフェッショナルとしての活躍とサポート。</p>
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-6 mb-2 highlightable-text" id="sub-tsuchiya_report-feedback">主なフィードバックとアクション</h3>
                        <div class="grid md:grid-cols-2 gap-4 highlightable-text">
                            <div class="p-4 bg-green-50 rounded-md">
                                <h4 class="text-base sm:text-lg font-semibold text-green-700 mb-1 highlightable-text">良かった点</h4>
                                <ul class="list-disc list-inside text-sm text-green-600 highlightable-text">
                                    <li class="highlightable-text">明確な目標設定と具体的な行動計画。</li>
                                    <li class="highlightable-text">社長報告に向けた準備。</li>
                                </ul>
                            </div>
                            <div class="p-4 bg-red-50 rounded-md">
                                <h4 class="text-base sm:text-lg font-semibold text-red-700 mb-1 highlightable-text">課題・改善点</h4>
                                <ul class="list-disc list-inside text-sm text-red-600 highlightable-text">
                                    <li class="highlightable-text"><strong>社長報告のポイント</strong>（KPTシート目的明確化、SS現状特に「人」情報、社長の関心事とのバランス）。</li>
                                    <li class="highlightable-text">「つむじ風」運営（計画的メンバー増、影響力拡大、参加しやすい雰囲気作り）。</li>
                                    <li class="highlightable-text">洗車実績分析（高単価メニューと作業時間のバランス、店舗オペレーション考慮）。</li>
                                </ul>
                            </div>
                        </div>
                        <h4 class="text-base sm:text-lg font-semibold text-sky-700 mt-4 mb-1 highlightable-text" id="sub-tsuchiya_report-actionitems">次回のアクション</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text">社長報告資料に、KPTシートの活用目的、各SSの「人」に関する現状報告、自身の分析・見解を追記する。</li>
                            <li class="highlightable-text">洗車リーダー・アルバイトリーダー会議を6月に実施し、理念浸透と等級制度の意義を強化する。</li>
                            <li class="highlightable-text">等級制度のバッジまたはステッカーの試作品を6月の会議で発表する。</li>
                            <li class="highlightable-text">Linyの全社的活用を検討・推進する。</li>
                            <li class="highlightable-text">堀之内SSでのトライさんへのOJTサポートを継続する。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="abe_manager_report" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-abe_manager_report-main">3-5. 阿部部長</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                        <img src="7.jpeg" alt="連携と未来技術 イメージ 7" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+7.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <div class="keyword-buttons-area mb-4">
                        <button class="keyword-btn" data-keyword="AIチャットボット" data-definition="AIを活用し、人間と自然な会話形式で対話できるプログラムです。顧客対応や情報提供の自動化に利用されます。">AIチャットボット</button>
                        <button class="keyword-btn" data-keyword="カンファレンス" data-definition="特定のテーマに関する大規模な会議や集会で、情報交換やネットワーキングの場となります。">カンファレンス</button>
                        <button class="keyword-btn" data-keyword="SaaS" data-definition="Software as a Serviceの略。インターネット経由で提供されるソフトウェアサービスで、必要な時に必要な分だけ利用できます。">SaaS</button>
                        <button class="keyword-btn" data-keyword="Notion" data-definition="ドキュメント作成、タスク管理、データベース構築などが可能な多機能な情報共有ツールです。">Notion</button>
                    </div>
                    <div class="text-content-for-highlight">
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-4 mb-2 highlightable-text" id="sub-abe_manager_report-content">報告内容</h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text">サイトウ様との業務委託（エアコンポスター作成など）。</li>
                            <li class="highlightable-text"><strong>AIチャットボット作成</strong>による自身の業務時間削減。</li>
                            <li class="highlightable-text"><strong>Zoom AI議事録</strong>の開始、会議用マイク導入。</li>
                            <li class="highlightable-text"><strong>Notionの活用推進</strong>による情報整理・ナレッジ共有。</li>
                            <li class="highlightable-text">LINEカンファレンスへの参加（最新情報の収集）。</li>
                            <li class="highlightable-text">マネージャー基礎研修への参加。</li>
                            <li class="highlightable-text"><strong>AI関連プロジェクトの推進</strong>:
                                <ul class="list-circle list-inside ml-4 highlightable-text">
                                    <li class="highlightable-text">リニーAI問合せチャットボット開発。</li>
                                    <li class="highlightable-text">AI Luca（相模原SSで試験運用）。</li>
                                    <li class="highlightable-text">AIによるウェブページ（LP）量産計画。</li>
                                </ul>
                            </li>
                            <li class="highlightable-text"><strong>SaaSアカウントの最適化提案</strong>:
                                <ul class="list-circle list-inside ml-4 highlightable-text">
                                    <li class="highlightable-text">Zoom、ChatGPTなどの有料アカウントを部署・会社単位で統合し、<strong>コストを削減</strong>。</li>
                                    <li class="highlightable-text">削減した費用を他の有望なAIツールの導入に充当する。</li>
                                </ul>
                            </li>
                        </ul>
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-6 mb-2 highlightable-text" id="sub-abe_manager_report-feedback">主なフィードバックとアクション</h3>
                        <div class="grid md:grid-cols-2 gap-4 highlightable-text">
                            <div class="p-4 bg-green-50 rounded-md">
                                <h4 class="text-base sm:text-lg font-semibold text-green-700 mb-1 highlightable-text">良かった点</h4>
                                <ul class="list-disc list-inside text-sm text-green-600 highlightable-text">
                                    <li class="highlightable-text">AI技術の積極的な導入と業務効率化への貢献。</li>
                                    <li class="highlightable-text">コスト意識と具体的な改善提案。</li>
                                </ul>
                            </div>
                            <div class="p-4 bg-red-50 rounded-md">
                                <h4 class="text-base sm:text-lg font-semibold text-red-700 mb-1 highlightable-text">課題・改善点</h4>
                                <ul class="list-disc list-inside text-sm text-red-600 highlightable-text">
                                    <li class="highlightable-text">AIによるウェブページ（LP）制作は、既存のホームページとの役割分担や連携を考慮する。</li>
                                    <li class="highlightable-text">SaaSアカウントの共有化は、利用規約やセキュリティ面も確認しつつ、運用ルールを策定する。</li>
                                </ul>
                            </div>
                        </div>
                        <h4 class="text-base sm:text-lg font-semibold text-sky-700 mt-4 mb-1 highlightable-text" id="sub-abe_manager_report-actionitems">次回のアクション</h4>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text">LINEカンファレンスの内容を企画部メンバーに共有する。</li>
                            <li class="highlightable-text">Zoom等のアカウント統合とAIツール導入に関する提案を社長に行う。</li>
                            <li class="highlightable-text">AIによるLP制作ツールの選定と導入準備を進める。</li>
                            <li class="highlightable-text">Notionの活用方法を部内で共有し、ナレッジマネジメントを強化する。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="overall_summary" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-overall_summary-main">4. まとめと課題</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                        <img src="8.jpeg" alt="会議のまとめと次のステップ イメージ 8" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+8.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <div class="keyword-buttons-area mb-4">
                        <button class="keyword-btn" data-keyword="A/Bテスト" data-definition="2つ以上の異なるパターンの広告やデザインを用意し、どちらがより高い効果を上げるかを比較検証するテスト手法です。">A/Bテスト</button>
                        <button class="keyword-btn" data-keyword="定性情報" data-definition="数値化できない質的な情報のこと。顧客の声やインタビュー、アンケートの自由記述などが該当します。">定性情報</button>
                        <button class="keyword-btn" data-keyword="アジェンダ管理" data-definition="会議の議題や進行計画（アジェンダ）を事前に準備し、それに沿って会議を効率的に運営することです。">アジェンダ管理</button>
                    </div>
                    <div class="text-content-for-highlight">
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-4 mb-2 highlightable-text" id="sub-overall_summary-decisions">主要な<strong>決定事項</strong>・確認事項</h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text">データに基づいた施策立案と<strong>効果検証のサイクル</strong>を徹底する。</li>
                            <li class="highlightable-text"><strong>A/Bテスト</strong>を積極的に導入し、各施策の最適化を図る。</li>
                            <li class="highlightable-text"><strong>AI技術の学習と活用</strong>を全部門で推進し、業務効率と成果向上を目指す。</li>
                            <li class="highlightable-text">現場の声を重視し、数値データと<strong>定性情報</strong>を組み合わせた分析を行う。</li>
                            <li class="highlightable-text"><strong>若手育成</strong>とチーム力強化のための取り組み（「つむじ風」など）を継続する。</li>
                        </ul>
                        <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mt-6 mb-2 highlightable-text" id="sub-overall_summary-challenges">今後の主な<strong>課題</strong></h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 highlightable-text">
                            <li class="highlightable-text">効果検証の精度向上と、具体的な改善アクションへの迅速な落とし込み。</li>
                            <li class="highlightable-text">各メンバーの資料作成能力、プレゼンテーション能力の向上。</li>
                            <li class="highlightable-text">長時間会議の効率化（<strong>アジェンダ管理</strong>、時間配分）。</li>
                            <li class="highlightable-text">SaaSツールの最適化と、費用対効果の高いAIツールの選定・導入。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <section id="action_items_list" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-action_items_list-main">5. 次回アクション一覧</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                        <img src="9.jpeg" alt="次回のアクション・チェックリスト イメージ 9" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+9.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <div id="action-items-accordion-container" class="space-y-4">
                        </div>
                    </div>
            </div>
        </section>

        <section id="meeting_evaluation" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-meeting_evaluation-main">6. 会議の評価</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                        <img src="10.jpeg" alt="会議の評価と改善サイクル イメージ 10" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+10.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <div class="keyword-buttons-area mb-4">
                        <button class="keyword-btn" data-keyword="AI活用" data-definition="人工知能技術を業務や施策に取り入れ、効率化や成果向上を目指すことです。">AI活用</button>
                        <button class="keyword-btn" data-keyword="データドリブン" data-definition="勘や経験だけに頼らず、収集・分析したデータに基づいて意思決定を行うアプローチです。">データドリブン</button>
                        <button class="keyword-btn" data-keyword="改善点" data-definition="現状よりも良くするための具体的なポイントや提案のことです。">改善点</button>
                    </div>
                    <div class="text-content-for-highlight">
                        <div class="grid md:grid-cols-3 gap-6">
                            <div>
                                <h3 class="text-lg sm:text-xl font-semibold text-green-700 mb-2 highlightable-text" id="sub-meeting_evaluation-good">良かった点</h3>
                                <ul class="list-disc list-inside space-y-1 text-green-600 highlightable-text">
                                    <li class="highlightable-text">各メンバーからの具体的な活動報告と進捗共有。</li>
                                    <li class="highlightable-text"><strong>データに基づいた分析</strong>と改善提案の活発化。</li>
                                    <li class="highlightable-text"><strong>AI活用</strong>への高い意識と具体的な取り組みの進展。</li>
                                    <li class="highlightable-text"><strong>組織変革</strong>に向けた新しい試み（KPTシート、「つむじ風」など）の開始。</li>
                                    <li class="highlightable-text">建設的なフィードバックと具体的な改善点の提示。</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg sm:text-xl font-semibold text-red-700 mb-2 highlightable-text" id="sub-meeting_evaluation-improve">改善点</h3>
                                <ul class="list-disc list-inside space-y-1 text-red-600 highlightable-text">
                                    <li class="highlightable-text">一部の分析における<strong>抽象化レベルの向上</strong>と、より深い洞察の必要性。</li>
                                    <li class="highlightable-text">効果検証における変数管理と<strong>現場ヒアリングの重要性</strong>の再認識。</li>
                                    <li class="highlightable-text">会議時間の効率化（アジェンダ管理、時間配分）。</li>
                                    <li class="highlightable-text">上位層への報告を意識した資料構成・ポイントの絞り込み。</li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-lg sm:text-xl font-semibold text-sky-700 mb-2 highlightable-text" id="sub-meeting_evaluation-overall">総評</h3>
                                <p class="text-slate-700 highlightable-text">活発な議論と具体的なアクションプランへの言及が多く、建設的な会議でした。特に<strong>AI活用</strong>と<strong>データドリブンな意思決定</strong>への強い志向が見受けられ、企画部としての進化が期待されます。一方で、分析の深さや報告の仕方には個人差があり、継続的なスキルアップと標準化が望まれます。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="final_remarks" class="content-section space-y-6 scroll-mt-16 md:scroll-mt-4">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="section-header">
                    <h2 class="text-xl sm:text-2xl font-semibold text-sky-600" id="sub-final_remarks-main">7. おわりに</h2>
                    <button class="toggle-content-btn">内容を確認する</button>
                </div>
                <div class="image-placeholder-container">
                    <div class="image-display-area">
                        <img src="11.jpeg" alt="未来への展望とチームワーク イメージ 11" onerror="this.onerror=null;this.src='https://placehold.co/600x250/E2E8F0/4A5568?text=Error+loading+11.jpeg';">
                    </div>
                </div>
                <div class="section-content-collapsible">
                    <p class="text-lg leading-relaxed highlightable-text">本日の会議で共有された内容、決定されたアクションを各々が<strong>確実に実行</strong>し、次回の会議で更なる進捗と成果を報告できるよう努めましょう。引き続き、<strong>チーム一丸</strong>となって<strong>価値創造</strong>に取り組んでいきましょう。</p>
                    <p class="mt-4 text-right font-semibold text-slate-700 highlightable-text">以上</p>
                </div>
            </div>
        </section>
    </div>

    <template id="contact-buttons-template">
        <div class="contact-buttons-container">
            <a href="mailto:abe@c-c-enelife" class="contact-btn email-contact-btn">部長へメールで問い合わせる</a>
            <a href="tel:08040645030" class="contact-btn phone-contact-btn">電話で問い合わせる</a>
        </div>
    </template>

    <div id="keyword-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-semibold text-sky-700">キーワード解説</h3>
                <button id="modal-close-btn" class="text-slate-500 hover:text-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p id="modal-definition" class="text-slate-700"></p>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async function () {
            // --- Fallback static data for Action Items (used if Firebase fails) ---
            const initialStaticActionItemsData = [ 
                { "担当者": "阿部部長", "actions": [
                    { "text": "LINEカンファレンス内容共有", "期限目安": "適宜", "status": "未着手", "notes": "" },
                    { "text": "SaaSアカウント最適化・AIツール導入提案（社長へ）", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "AIによるLP制作ツール選定・導入準備", "期限目安": "適宜", "status": "未着手", "notes": "" },
                    { "text": "Notion活用共有と強化", "期限目安": "適宜", "status": "未着手", "notes": "" }
                ]},
                { "担当者": "千早 克典 氏", "actions": [ 
                    { "text": "効果検証フォーマット確立と数値報告", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "バナー制作時のA/Bテスト必須化と結果共有", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "Liny構築SOP確立と時間管理", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "AI画像生成スキル向上", "期限目安": "次回報告時", "status": "未着手", "notes": "" }
                ]},
                { "担当者": "藤方 優樹 氏", "actions": [ 
                    { "text": "効果検証時の現場ヒアリング必須化", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "AI活用によるデータ分析訓練", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "One Team年間実績表に累計データ追加", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "家内SS予約システム刷新効果の分析方法再検討", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "永井石油様Liny構築完了", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "小出氏からのデジプリ販売者特定依頼対応", "期限目安": "次回報告時", "status": "未着手", "notes": "" }
                ]},
                { "担当者": "篤史 渡辺 氏", "actions": [ 
                    { "text": "名刺QRツールデザイン改善", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "名刺QRツール効果測定体制構築（配布数、読込数、A/Bテスト計画）", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "企画部会議報告フォーマット確立", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "大石氏との店舗作り知見共有調整", "期限目安": "次回報告時", "status": "未着手", "notes": "" }
                ]},
                { "担当者": "Takuro Tsuchiya 氏", "actions": [ 
                    { "text": "社長報告資料ブラッシュアップ", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "洗車リーダー・アルバイトリーダー会議実施（6月）", "期限目安": "2024-06-30", "status": "未着手", "notes": "" }, 
                    { "text": "等級制度バッジ/ステッカー試作品発表（6月）", "期限目安": "2024-06-30", "status": "未着手", "notes": "" }, 
                    { "text": "Liny全社活用検討", "期限目安": "次回報告時", "status": "未着手", "notes": "" },
                    { "text": "堀之内SS トライさんOJTサポート継続", "期限目安": "継続", "status": "進行中", "notes": "" }
                ]},
                { "担当者": "全員", "actions": [
                    { "text": "データに基づいた改善活動の推進", "期限目安": "継続", "status": "未着手", "notes": "" },
                    { "text": "AI技術の積極的な学習と活用", "期限目安": "継続", "status": "未着手", "notes": "" },
                    { "text": "メンバー間の連携強化と情報共有", "期限目安": "継続", "status": "未着手", "notes": "" }
                ]}
            ];

            // --- Firebase Configuration (Provided by User) ---
            const firebaseConfig = {
                apiKey: "AIzaSyCbCN-W0SKWJSU-O7X0OBlHXsCgPQPVHxU",
                authDomain: "git1-f2fab.firebaseapp.com",
                projectId: "git1-f2fab",
                storageBucket: "git1-f2fab.appspot.com", 
                messagingSenderId: "65572070062",
                appId: "1:65572070062:web:39b5887ff149659357433f",
                measurementId: "G-Z5BZCZ4SCN"
            };

            // --- Global Variables & Canvas Provided Config ---
            const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; 
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            let firebaseApp;
            let db;
            let auth;
            let userId = 'anonymous'; 
            let actionItemsRef;
            let uiStateRef; // Firestore reference for UI state
            let actionItemsUnsubscribe = null; 
            let uiStateUnsubscribe = null; // Firestore listener for UI state

            let currentActionItemsData = JSON.parse(JSON.stringify(initialStaticActionItemsData)); 
            let currentUiState = { // Default UI state
                activeKeywords: {}, // { sectionId: keyword }
                openSections: {},   // { sectionId: true/false }
                highlightedSentences: {} // { sectionId: [sentenceText1, sentenceText2] }
            };
            let activeSectionId = ""; 
            let firebaseInitialized = false;
            let dataHasUnsavedChanges = false; // Combined flag for both action items and UI state

            const globalSaveButtonContainer = document.getElementById('fixed-save-button-container');
            const globalSaveButton = document.getElementById('global-save-action-items-btn');
            const globalSaveStatusMessage = document.getElementById('global-save-status-message');


            async function initializeFirebase() {
                try {
                    if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) { 
                        firebaseApp = initializeApp(firebaseConfig);
                        db = getFirestore(firebaseApp);
                        auth = getAuth(firebaseApp);
                        // setLogLevel('debug'); 

                        await new Promise((resolve, reject) => {
                            const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                                unsubscribeAuth(); 
                                if (user) {
                                    userId = user.uid;
                                    console.log("Firebase: User is signed in with UID:", userId);
                                    firebaseInitialized = true;
                                    resolve(user);
                                } else {
                                    try {
                                        if (initialAuthToken) {
                                            console.log("Firebase: Attempting to sign in with custom token...");
                                            try {
                                                const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                                                userId = userCredential.user.uid;
                                                console.log("Firebase: Signed in with custom token. UID:", userId);
                                                firebaseInitialized = true;
                                                resolve(auth.currentUser);
                                            } catch (customTokenError) {
                                                console.warn("Firebase: Custom token sign-in failed:", customTokenError);
                                                console.log("Firebase: Falling back to anonymous sign-in after custom token failure...");
                                                const userCredentialAnonym = await signInAnonymously(auth);
                                                userId = userCredentialAnonym.user.uid;
                                                firebaseInitialized = true;
                                                console.log("Firebase: Signed in anonymously after custom token failure. UID:", userId);
                                                resolve(auth.currentUser);
                                            }
                                        } else {
                                            console.log("Firebase: No custom token, attempting to sign in anonymously...");
                                            const userCredentialAnonym = await signInAnonymously(auth);
                                            userId = userCredentialAnonym.user.uid;
                                            firebaseInitialized = true;
                                            console.log("Firebase: Signed in anonymously. UID:", userId);
                                            resolve(auth.currentUser);
                                        }
                                    } catch (signInError) { 
                                        console.error("Firebase: Error during fallback sign-in attempts:", signInError);
                                        firebaseInitialized = false; 
                                        reject(signInError); 
                                    }
                                }
                            }, (authError) => { 
                                console.error("Firebase: Error in onAuthStateChanged listener:", authError);
                                firebaseInitialized = false;
                                reject(authError);
                            });
                        });
                        
                        actionItemsRef = doc(db, "artifacts", canvasAppId, "public", "data", "meetingReportData", "actionItems");
                        uiStateRef = doc(db, "artifacts", canvasAppId, "public", "data", "meetingReportData", "uiState");
                        
                    } else {
                        console.warn("Firebase config is invalid or missing. Firestore features will be disabled.");
                        firebaseInitialized = false;
                    }
                } catch (e) {
                    console.error("Error initializing Firebase or during auth promise:", e); 
                    firebaseInitialized = false;
                }

                // Initialize UI and load data based on Firebase status
                initializeUI(); // This will set up the basic page structure

                if (firebaseInitialized) {
                    loadAndApplyData(); // Loads both action items and UI state from Firestore
                    if (globalSaveButtonContainer) globalSaveButtonContainer.style.display = 'block'; 
                } else {
                    // Fallback if Firebase couldn't initialize
                    const actionItemsAccordionContainer = document.getElementById('action-items-accordion-container');
                    if(actionItemsAccordionContainer) populateActionItemsAccordion(actionItemsAccordionContainer, currentActionItemsData);
                    applyUiStateToDOM(currentUiState); // Apply default UI state
                    if (globalSaveButtonContainer) globalSaveButtonContainer.style.display = 'none'; 
                }
                updateGlobalSaveButtonState(); 
            }

            function updateGlobalSaveButtonState() {
                if (globalSaveButton) {
                    if (dataHasUnsavedChanges && firebaseInitialized && auth && auth.currentUser) {
                        globalSaveButton.disabled = false;
                        globalSaveButton.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                        globalSaveButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    } else {
                        globalSaveButton.disabled = true;
                        globalSaveButton.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                        globalSaveButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                    }
                }
            }
            
            if (globalSaveButton) {
                globalSaveButton.addEventListener('click', async () => {
                    if (!dataHasUnsavedChanges) {
                        if (globalSaveStatusMessage) {
                            globalSaveStatusMessage.textContent = '変更はありません';
                            globalSaveStatusMessage.className = 'ml-2 text-sm text-slate-500';
                            setTimeout(() => { globalSaveStatusMessage.textContent = ''; }, 2000);
                        }
                        return;
                    }

                    if (globalSaveStatusMessage) {
                        globalSaveStatusMessage.textContent = '保存中...';
                        globalSaveStatusMessage.className = 'ml-2 text-sm text-blue-500';
                    }
                    globalSaveButton.disabled = true;

                    try {
                        await saveAllDataToFirestore();
                        // Success message is handled within saveAllDataToFirestore
                        // dataHasUnsavedChanges is reset in saveAllDataToFirestore
                    } catch (error) {
                        console.error("Error saving from global button click:", error);
                        // Error message is handled within saveAllDataToFirestore
                    } finally {
                         updateGlobalSaveButtonState(); 
                    }
                });
            }


            // --- DOM Element References (rest of the elements) ---
            const sidebar = document.getElementById('sidebar');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const nav = document.getElementById('main-nav');
            const mainContentArea = document.getElementById('main-content-area');
            const allSectionsTemplateContainer = document.getElementById('all-sections-template');
            const keywordModal = document.getElementById('keyword-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalDefinition = document.getElementById('modal-definition');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const contactButtonsTemplate = document.getElementById('contact-buttons-template');
            const printPageBtn = document.getElementById('print-page-btn');
            const audioGuideShortcutLink = document.getElementById('audio-guide-shortcut-link'); 
            let animationObserver = null;

            if (!sidebar || !mobileMenuButton || !nav || !mainContentArea || !allSectionsTemplateContainer || !keywordModal || !modalTitle || !modalDefinition || !modalCloseBtn || !contactButtonsTemplate || !printPageBtn || !audioGuideShortcutLink) {
                console.error("Fatal Error: One or more essential HTML elements are missing. Page functionality will be limited.");
                if (mainContentArea) {
                    mainContentArea.innerHTML = "<p class='text-red-500 p-4'>ページの読み込みにエラーが発生しました。重要な要素が見つかりません。</p>";
                }
            }

            const originalSections = {}; 
            const sidebarStructure = []; 

            try {
                allSectionsTemplateContainer.querySelectorAll('section.content-section').forEach(section => {
                    if (!section.id) {
                        console.warn("Section in template is missing an ID. Skipping.", section);
                        return; 
                    }
                    originalSections[section.id] = section.cloneNode(true); 
                    const h2 = section.querySelector('h2');
                    let sectionTitle = section.id; 
                    if (h2 && h2.textContent) {
                        let fullTitleText = h2.textContent.trim();
                        const titleParts = fullTitleText.split('. ');
                        sectionTitle = titleParts.length > 1 ? titleParts.slice(1).join('. ') : titleParts[0];
                        
                        const reportSections = ["chihaya_report", "fujikata_report", "watanabe_a_report", "tsuchiya_report", "abe_manager_report"];
                        if (reportSections.includes(section.id)) {
                            if (sectionTitle.endsWith(" 氏")) { 
                            } else if (sectionTitle.endsWith(" 氏 報告")) { 
                                sectionTitle = sectionTitle.replace(" 氏 報告", " 氏");
                            } else if (sectionTitle.endsWith(" 報告")) { 
                                sectionTitle = sectionTitle.replace(" 報告", "");
                            }
                        }
                        if (section.id === "action_items_list") sectionTitle = "次回アクション一覧";
                        if (section.id === "overall_summary") sectionTitle = "まとめと課題";
                    }
                    
                    let currentCategory = null;
                    if (["intro", "abe_share"].includes(section.id)) { currentCategory = null; } 
                    else if (["chihaya_report", "fujikata_report", "watanabe_a_report", "tsuchiya_report", "abe_manager_report"].includes(section.id)) { currentCategory = "各担当者報告"; } 
                    else if (["overall_summary", "action_items_list", "meeting_evaluation", "final_remarks"].includes(section.id)) { currentCategory = "会議総括・その他"; }
                    else { currentCategory = null; } 

                    const lastSidebarItem = sidebarStructure.length > 0 ? sidebarStructure[sidebarStructure.length -1] : null;
                    if (currentCategory && (!lastSidebarItem || lastSidebarItem.type !== 'header' || lastSidebarItem.title !== currentCategory) ) {
                        sidebarStructure.push({type: 'header', title: currentCategory});
                    }
                    sidebarStructure.push({type: 'link', id: section.id, title: sectionTitle});
                    
                    const collapsibleContent = originalSections[section.id].querySelector('.section-content-collapsible');
                    if (collapsibleContent) {
                        collapsibleContent.style.display = 'none'; 
                    }
                });
            } catch (e) {
                console.error("Error processing #all-sections-template children:", e);
                if (mainContentArea) mainContentArea.innerHTML = "<p class='text-red-500 p-4'>コンテンツテンプレートの読み込みエラーが発生しました。</p>";
            }
            
            try {
                nav.innerHTML = ''; 
                let lastHeader = null; 
                sidebarStructure.forEach(item => {
                    if (item.type === 'header') {
                        if(item.title !== lastHeader) { 
                            const h2_nav = document.createElement('h2'); 
                            h2_nav.className = 'text-sm font-semibold text-slate-400 mt-4 mb-2 px-4';
                            h2_nav.textContent = item.title;
                            nav.appendChild(h2_nav);
                            lastHeader = item.title; 
                        }
                    } else if (item.type === 'link') {
                        const a = document.createElement('a');
                        a.href = '#' + item.id;
                        a.className = 'sidebar-link block py-2.5 px-4 rounded transition duration-200 hover:bg-sky-700 hover:text-white';
                        a.dataset.target = item.id;
                        a.textContent = item.title;
                        nav.appendChild(a);
                    }
                });
            } catch (e) {
                console.error("Error building sidebar navigation:", e);
            }
            
            async function saveAllDataToFirestore() {
                if (!firebaseInitialized || !db || !auth.currentUser) {
                    console.warn("Firestore is not initialized or user not authenticated. Cannot save data.");
                    if (globalSaveStatusMessage) {
                        globalSaveStatusMessage.textContent = '保存できません(未認証/接続エラー)';
                        globalSaveStatusMessage.className = 'ml-2 text-sm text-red-500';
                        setTimeout(() => { globalSaveStatusMessage.textContent = ''; }, 3000);
                    }
                    return Promise.reject("Firestore not ready or user not authenticated");
                }

                // Collect current UI state from DOM
                collectUiStateFromDOM();

                try {
                    console.log("Firebase: Saving all data to Firestore...");
                    // Save Action Items
                    if (actionItemsRef) { // Check if ref is defined
                        await setDoc(actionItemsRef, { actions: currentActionItemsData, lastUpdated: serverTimestamp(), updatedBy: userId });
                        console.log("Firebase: Action items saved successfully.");
                    } else {
                         console.warn("Firebase: actionItemsRef is not defined. Cannot save action items.");
                    }
                    
                    // Save UI State
                    if (uiStateRef) { // Check if ref is defined
                        await setDoc(uiStateRef, { ...currentUiState, lastUpdated: serverTimestamp(), updatedBy: userId });
                        console.log("Firebase: UI state saved successfully.");
                    } else {
                        console.warn("Firebase: uiStateRef is not defined. Cannot save UI state.");
                    }


                    if (globalSaveStatusMessage) {
                        globalSaveStatusMessage.textContent = '保存しました！';
                        globalSaveStatusMessage.className = 'ml-2 text-sm text-green-500';
                        setTimeout(() => { globalSaveStatusMessage.textContent = ''; }, 2000);
                    }
                    dataHasUnsavedChanges = false;
                    updateGlobalSaveButtonState();
                    return Promise.resolve();
                } catch (error) {
                    console.error("Firebase: Error saving data to Firestore:", error);
                    if (globalSaveStatusMessage) {
                        globalSaveStatusMessage.textContent = '保存失敗';
                        globalSaveStatusMessage.className = 'ml-2 text-sm text-red-500';
                        setTimeout(() => { globalSaveStatusMessage.textContent = ''; }, 3000);
                    }
                    updateGlobalSaveButtonState(); // Still update button state on failure
                    return Promise.reject(error);
                }
            }

            function loadAndApplyData() {
                if (!firebaseInitialized || !db || !auth.currentUser) { 
                    console.warn("Firestore is not initialized or user not authenticated. Using initial static data.");
                    currentActionItemsData = JSON.parse(JSON.stringify(initialStaticActionItemsData));
                    // currentUiState remains default
                    const actionItemsContainer = document.getElementById('action-items-accordion-container');
                    if (actionItemsContainer) populateActionItemsAccordion(actionItemsContainer, currentActionItemsData);
                    applyUiStateToDOM(currentUiState); // Apply default UI state
                    updateGlobalSaveButtonState();
                    return;
                }

                // Load Action Items
                if (actionItemsRef) {
                    if (actionItemsUnsubscribe) actionItemsUnsubscribe();
                    actionItemsUnsubscribe = onSnapshot(actionItemsRef, (docSnap) => {
                        if (docSnap.exists() && docSnap.data() && Array.isArray(docSnap.data().actions)) {
                            currentActionItemsData = JSON.parse(JSON.stringify(docSnap.data().actions));
                        } else {
                            currentActionItemsData = JSON.parse(JSON.stringify(initialStaticActionItemsData));
                             if(firebaseInitialized && auth.currentUser && !docSnap.exists()) { // Only save if doc truly doesn't exist
                                console.log("Firebase: Action items doc does not exist, saving initial data.");
                                // setDoc(actionItemsRef, { actions: currentActionItemsData, lastUpdated: serverTimestamp(), updatedBy: userId });
                             }
                        }
                        dataHasUnsavedChanges = false; 
                        updateGlobalSaveButtonState();
                        if (activeSectionId === 'action_items_list' || mainContentArea.querySelector('#action_items_list')) {
                            const container = mainContentArea.querySelector('#action_items_list #action-items-accordion-container') || document.getElementById('action-items-accordion-container');
                            if (container) populateActionItemsAccordion(container, currentActionItemsData);
                        }
                    }, (error) => {
                        console.error("Firebase: Error listening to action items:", error);
                        currentActionItemsData = JSON.parse(JSON.stringify(initialStaticActionItemsData));
                        const container = document.getElementById('action-items-accordion-container');
                        if (container) populateActionItemsAccordion(container, currentActionItemsData);
                    });
                } else {
                     console.warn("Firebase: actionItemsRef is not defined. Cannot load action items.");
                }


                // Load UI State
                if(uiStateRef) {
                    if (uiStateUnsubscribe) uiStateUnsubscribe();
                    uiStateUnsubscribe = onSnapshot(uiStateRef, (docSnap) => {
                        if (docSnap.exists() && docSnap.data()) {
                            console.log("Firebase: UI state loaded from Firestore:", docSnap.data());
                            currentUiState = { ...currentUiState, ...docSnap.data() }; 
                        } else {
                            console.log("Firebase: No UI state document. Using defaults.");
                             if(firebaseInitialized && auth.currentUser && !docSnap.exists()) {
                                console.log("Firebase: UI state doc does not exist, saving initial/default UI state.");
                                // setDoc(uiStateRef, { ...currentUiState, lastUpdated: serverTimestamp(), updatedBy: userId });
                             }
                        }
                        applyUiStateToDOM(currentUiState); 
                        dataHasUnsavedChanges = false; 
                        updateGlobalSaveButtonState();
                    }, (error) => {
                        console.error("Firebase: Error listening to UI state:", error);
                        applyUiStateToDOM(currentUiState); 
                    });
                } else {
                    console.warn("Firebase: uiStateRef is not defined. Cannot load UI state.");
                    applyUiStateToDOM(currentUiState); // Apply defaults if ref is missing
                }
            }
            
            function collectUiStateFromDOM() {
                const newUiState = {
                    activeKeywords: {},
                    openSections: {},
                    highlightedSentences: {}
                };
                document.querySelectorAll('.content-section').forEach(section => {
                    const sectionId = section.id;
                    if (!sectionId) return;

                    // Collect active keyword
                    const activeKeywordBtn = section.querySelector('.keyword-btn.active-highlight');
                    if (activeKeywordBtn) {
                        newUiState.activeKeywords[sectionId] = activeKeywordBtn.dataset.keyword;
                    }

                    // Collect open/closed state
                    const collapsibleContent = section.querySelector('.section-content-collapsible');
                    if (collapsibleContent) {
                        newUiState.openSections[sectionId] = (collapsibleContent.style.display === 'block');
                    }

                    // Collect highlighted sentences
                    const sentences = [];
                    section.querySelectorAll('.clickable-sentence-part.sentence-highlight').forEach(span => {
                        sentences.push(span.textContent); 
                    });
                    if (sentences.length > 0) {
                        newUiState.highlightedSentences[sectionId] = sentences;
                    }
                });
                currentUiState = newUiState; 
                console.log("Collected UI State from DOM:", currentUiState);
            }

            function applyUiStateToDOM(stateToApply) {
                if (!stateToApply) return;
                console.log("Applying UI State to DOM:", stateToApply);

                document.querySelectorAll('.content-section').forEach(section => {
                    const sectionId = section.id;
                    if (!sectionId) return;

                    // Apply active keyword
                    if (stateToApply.activeKeywords && stateToApply.activeKeywords[sectionId]) {
                        const keywordToActivate = stateToApply.activeKeywords[sectionId];
                        section.querySelectorAll('.keyword-btn').forEach(btn => {
                            if (btn.dataset.keyword === keywordToActivate) {
                                if (!btn.classList.contains('active-highlight')) btn.click(); // Simulate click only if not already active
                            } else {
                                btn.classList.remove('active-highlight');
                            }
                        });
                    } else {
                         section.querySelectorAll('.keyword-btn.active-highlight').forEach(btn => btn.classList.remove('active-highlight'));
                         const contentArea = section.querySelector('.text-content-for-highlight');
                         if(contentArea) {
                            const allHighlightedSpans = contentArea.querySelectorAll('span.highlight');
                            allHighlightedSpans.forEach(span => {
                                const parent = span.parentNode;
                                if (parent) {
                                    while (span.firstChild) { parent.insertBefore(span.firstChild, span); }
                                    parent.removeChild(span);
                                    parent.normalize(); 
                                }
                            });
                         }
                    }


                    // Apply open/closed state
                    const collapsibleContent = section.querySelector('.section-content-collapsible');
                    const toggleButton = section.querySelector('.toggle-content-btn');
                    if (collapsibleContent && toggleButton) {
                        const shouldBeOpen = stateToApply.openSections && stateToApply.openSections[sectionId] === true;
                        collapsibleContent.style.display = shouldBeOpen ? 'block' : 'none';
                        toggleButton.textContent = shouldBeOpen ? '内容を閉じる' : '内容を確認する';
                    }
                    
                    // Apply highlighted sentences
                    section.querySelectorAll('.clickable-sentence-part.sentence-highlight').forEach(span => {
                        span.classList.remove('sentence-highlight');
                    });
                    if (stateToApply.highlightedSentences && stateToApply.highlightedSentences[sectionId]) {
                        const sentencesToHighlight = stateToApply.highlightedSentences[sectionId];
                        section.querySelectorAll('.clickable-sentence-part').forEach(span => {
                            if (sentencesToHighlight.includes(span.textContent)) {
                                span.classList.add('sentence-highlight');
                            }
                        });
                    }
                });
            }


            function populateActionItemsAccordion(containerElement, dataToUse) { 
                if (!containerElement) {
                    console.warn(`Action items accordion container element not found for population.`);
                    return;
                }
                containerElement.innerHTML = ''; 

                if (!Array.isArray(dataToUse)) {
                    console.error("Data provided to populateActionItemsAccordion is not an array:", dataToUse);
                    dataToUse = []; 
                }


                dataToUse.forEach((personData, personIndex) => {
                    if (!personData || typeof personData["担当者"] === 'undefined' || !Array.isArray(personData.actions)) {
                        console.warn("Invalid personData structure at index", personIndex, ":", personData);
                        return; 
                    }

                    const accordionItem = document.createElement('div');
                    accordionItem.classList.add('accordion-item');

                    const accordionHeader = document.createElement('div');
                    accordionHeader.classList.add('accordion-header');
                    accordionHeader.innerHTML = `
                        <span>${personData["担当者"]}</span>
                        <span class="accordion-arrow">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
                            </svg>
                        </span>
                    `;

                    const accordionContent = document.createElement('div');
                    accordionContent.classList.add('accordion-content');

                    personData.actions.forEach((action, actionIndex) => {
                        const actionDetailDiv = document.createElement('div');
                        actionDetailDiv.classList.add('action-detail');

                        actionDetailDiv.innerHTML += `
                            <div>
                                <p class="action-detail-value action-text-value highlightable-text"><strong>${actionIndex + 1}. ${action.text}</strong></p>
                            </div>
                        `;

                        const deadlineDiv = document.createElement('div');
                        deadlineDiv.classList.add('action-field-group'); 
                        deadlineDiv.innerHTML = `
                            <span class="action-detail-label">期限</span> 
                            <div class="action-detail-value">
                                <select class="deadline-type-select p-1 border border-slate-300 rounded-md text-xs w-full mb-1" data-person-index="${personIndex}" data-action-index="${actionIndex}">
                                    <option value="適宜">適宜</option>
                                    <option value="次回報告時">次回報告時</option>
                                    <option value="日付指定">日付指定</option>
                                    <option value="継続">継続</option>
                                </select>
                                <input type="date" class="deadline-date-input p-1 border border-slate-300 rounded-md text-xs w-full" data-person-index="${personIndex}" data-action-index="${actionIndex}" style="display:none;">
                            </div>`;
                        actionDetailDiv.appendChild(deadlineDiv);

                        const statusDiv = document.createElement('div');
                        statusDiv.classList.add('action-field-group'); 
                        statusDiv.innerHTML = `
                            <span class="action-detail-label">進捗</span>
                            <div class="action-detail-value">
                                <select class="action-status-select p-1 border border-slate-300 rounded-md text-xs w-full" data-person-index="${personIndex}" data-action-index="${actionIndex}">
                                    <option value="未着手">未着手</option>
                                    <option value="進行中">進行中</option>
                                    <option value="完了">完了！🎉</option> 
                                </select>
                            </div>`;
                        actionDetailDiv.appendChild(statusDiv);
                        
                        const notesDiv = document.createElement('div');
                        notesDiv.innerHTML = `
                            <div class="action-detail-value">
                                <textarea class="action-notes-input p-1 border border-slate-300 rounded-md text-xs w-full" data-person-index="${personIndex}" data-action-index="${actionIndex}" placeholder="メモ...">${action.notes || ''}</textarea>
                            </div>`;
                        actionDetailDiv.appendChild(notesDiv);

                        accordionContent.appendChild(actionDetailDiv);

                        const deadlineTypeSelect = deadlineDiv.querySelector('.deadline-type-select');
                        const deadlineDateInput = deadlineDiv.querySelector('.deadline-date-input');
                        const statusSelectInput = statusDiv.querySelector('.action-status-select');
                        
                        statusSelectInput.value = action.status; 
                        if (action["期限目安"]) {
                            if (["適宜", "次回報告時", "継続"].includes(action["期限目安"])) {
                                deadlineTypeSelect.value = action["期限目安"];
                                deadlineDateInput.style.display = 'none';
                            } else if (/^\d{4}-\d{2}-\d{2}$/.test(action["期限目安"])) { 
                                deadlineTypeSelect.value = "日付指定";
                                deadlineDateInput.value = action["期限目安"];
                                deadlineDateInput.style.display = 'block';
                            } else { 
                                deadlineTypeSelect.value = "適宜";
                                deadlineDateInput.style.display = 'none';
                            }
                        } else { 
                            deadlineTypeSelect.value = "適宜";
                            deadlineDateInput.style.display = 'none';
                        }
                    });

                    accordionHeader.addEventListener('click', () => {
                        accordionHeader.classList.toggle('active');
                        const content = accordionHeader.nextElementSibling;
                        if (content && content.style) {
                            if (content.style.display === "block") {
                                content.style.display = "none";
                            } else {
                                content.style.display = "block";
                            }
                        } else {
                             console.warn("Accordion content not found or style property missing for header:", accordionHeader);
                        }
                        // UI state change, mark as unsaved
                        dataHasUnsavedChanges = true;
                        updateGlobalSaveButtonState();
                    });

                    accordionItem.appendChild(accordionHeader);
                    accordionItem.appendChild(accordionContent);
                    containerElement.appendChild(accordionItem); 
                });
                attachSentenceHighlightListeners(containerElement); 
                attachActionItemListeners(containerElement); 
            }


            function initializeScrollAnimations(container) {
                if (animationObserver) {
                    animationObserver.disconnect(); 
                }
                const elementsToAnimate = container.querySelectorAll('.content-section > .bg-white.p-6.rounded-lg.shadow-lg');
                const observerCallback = (entries, observerInstance) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('animate-fade-in-up');
                            observerInstance.unobserve(entry.target); 
                        }
                    });
                };
                animationObserver = new IntersectionObserver(observerCallback, { threshold: 0.1 }); 
                elementsToAnimate.forEach(el => {
                    if (!el.classList.contains('animate-fade-in-up')) { 
                       animationObserver.observe(el);
                    }
                });
            }
            
            function renderContent(targetId, scrollToAudioGuide = false, fromSnapshot = false) {
                activeSectionId = targetId; 
                if (!mainContentArea || !allSectionsTemplateContainer) {
                    console.error("Render Error: Main content area or template container not found.");
                    if(mainContentArea) mainContentArea.innerHTML = "<p class='text-red-500 p-4'>コンテンツの表示にエラーが発生しました。</p>";
                    return;
                }
                
                mainContentArea.innerHTML = ''; 

                const selectedSectionOriginal = originalSections[targetId];
                if (selectedSectionOriginal) {
                    const selectedSectionClone = selectedSectionOriginal.cloneNode(true);
                    const mainCardOfSelectedSection = selectedSectionClone.querySelector('.bg-white.p-6.rounded-lg.shadow-lg');
                    if (mainCardOfSelectedSection) {
                        mainCardOfSelectedSection.classList.add('animate-fade-in-up');
                    }
                    
                    const topCollapsible = selectedSectionClone.querySelector('.section-content-collapsible');
                    if (topCollapsible) {
                        // Apply saved open/closed state before displaying
                        if (currentUiState.openSections && typeof currentUiState.openSections[targetId] !== 'undefined') {
                            topCollapsible.style.display = currentUiState.openSections[targetId] ? 'block' : 'none';
                            const topToggleButton = selectedSectionClone.querySelector('.toggle-content-btn');
                            if (topToggleButton) topToggleButton.textContent = currentUiState.openSections[targetId] ? '内容を閉じる' : '内容を確認する';
                        } else { // Default to open for the primary selected section if no state saved
                            topCollapsible.style.display = 'block';
                            const topToggleButton = selectedSectionClone.querySelector('.toggle-content-btn');
                            if(topToggleButton) topToggleButton.textContent = '内容を閉じる';
                        }


                        if (targetId === 'action_items_list') { 
                           const accordionContainer = selectedSectionClone.querySelector('#action-items-accordion-container');
                           if (accordionContainer ) {
                               populateActionItemsAccordion(accordionContainer, currentActionItemsData); 
                           }
                        }
                    }
                    mainContentArea.appendChild(selectedSectionClone);
                    
                    if (!fromSnapshot) { 
                        setTimeout(() => {
                            let elementToScrollTo = mainContentArea.firstChild;
                            if (scrollToAudioGuide && targetId === 'intro') {
                                const audioContainer = mainContentArea.querySelector('#intro .audio-guide-container');
                                const audioPlayer = mainContentArea.querySelector('#main-audio-player'); 
                                if (audioContainer) elementToScrollTo = audioContainer;
                                if (audioPlayer && typeof audioPlayer.play === 'function') {
                                    audioPlayer.play().catch(e => console.warn("Audio play failed:", e));
                                }
                            }

                            if (elementToScrollTo && typeof elementToScrollTo.getBoundingClientRect === 'function') {
                                const mobileMenuContainer = document.getElementById('mobile-menu-button-container');
                                const headerOffset = mobileMenuContainer && window.getComputedStyle(mobileMenuContainer).display !== 'none' ? mobileMenuContainer.offsetHeight : 0;
                                const elementPosition = elementToScrollTo.getBoundingClientRect().top;
                                const offsetPosition = elementPosition + window.pageYOffset - (headerOffset + 16); 
                                window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                            }
                        }, 100); 
                    }
                } else {
                    console.warn("Section with ID " + targetId + " not found in template for selected display.");
                    if (mainContentArea) mainContentArea.innerHTML = "<p class='text-orange-500 p-4'>選択されたセクションが見つかりませんでした。</p>";
                    return; 
                }

                if (targetId !== 'intro') { 
                    const separator = document.createElement('div');
                    separator.className = 'overall-display-title';
                    separator.textContent = 'ー 全体表示 ー';
                    mainContentArea.appendChild(separator);
                }

                const allSectionsContainer = document.createElement('div'); 
                mainContentArea.appendChild(allSectionsContainer);

                Object.keys(originalSections).forEach(sectionId => {
                    if (targetId === 'intro' && sectionId === 'intro') {
                        return; 
                    }
                    if (sectionId === targetId && targetId !== 'intro') {
                        return;
                    }

                    const sectionOriginal = originalSections[sectionId];
                    if (sectionOriginal) {
                        const sectionCardClone = sectionOriginal.cloneNode(true); 
                        
                        const sectionWrapper = document.createElement('div');
                        sectionWrapper.className = 'content-section-wrapper'; 
                        sectionWrapper.appendChild(sectionCardClone);

                        const collapsible = sectionCardClone.querySelector('.section-content-collapsible');
                        const toggleButton = sectionCardClone.querySelector('.toggle-content-btn');
                        
                        if (collapsible && toggleButton) {
                            if (currentUiState.openSections && typeof currentUiState.openSections[sectionId] !== 'undefined') {
                                collapsible.style.display = currentUiState.openSections[sectionId] ? 'block' : 'none';
                                toggleButton.textContent = currentUiState.openSections[sectionId] ? '内容を閉じる' : '内容を確認する';
                            } else { // Default to closed for non-primary sections
                                collapsible.style.display = 'none'; 
                                toggleButton.textContent = '内容を確認する';
                            }
                        }
                        sectionCardClone.classList.add('scroll-mt-16', 'md:scroll-mt-4'); 
                        allSectionsContainer.appendChild(sectionWrapper); 

                        if (sectionId === 'action_items_list') {
                           const accordionContainer = sectionCardClone.querySelector('#action-items-accordion-container');
                           if (accordionContainer) {
                               populateActionItemsAccordion(accordionContainer, currentActionItemsData); 
                           }
                        }
                    } else {
                        console.warn("Section with ID " + sectionId + " not found in template for overall display.");
                    }
                });
                
                if (contactButtonsTemplate) {
                    mainContentArea.appendChild(contactButtonsTemplate.content.cloneNode(true));
                } else {
                    console.warn("Contact buttons template not found.");
                }

                attachAllEventListeners(mainContentArea); 
                applyUiStateToDOM(currentUiState); // Apply UI state after rendering all sections
                if (!fromSnapshot) { 
                    initializeScrollAnimations(allSectionsContainer); 
                }
            }
            
            function attachAllEventListeners(parentElement) {
                if (!parentElement) return;
                attachKeywordButtonListeners(parentElement);
                attachToggleContentButtonListeners(parentElement);
                
                parentElement.querySelectorAll('.text-content-for-highlight').forEach(contentArea => {
                    if (!contentArea.closest('#action-items-accordion-container')) { 
                        attachSentenceHighlightListeners(contentArea);
                    }
                });
            }

            function updateActiveLink(targetIdOrSubId) {
                if (!nav) return;
                let mainTargetId = targetIdOrSubId;
                const activeLinkElement = nav.querySelector('.sidebar-link[data-target="' + targetIdOrSubId + '"], .sub-sidebar-link[data-target="' + targetIdOrSubId + '"]');
                if (activeLinkElement && activeLinkElement.dataset.parentTarget) {
                    mainTargetId = activeLinkElement.dataset.parentTarget;
                }

                nav.querySelectorAll('.sidebar-link, .sub-sidebar-link').forEach(link => {
                    link.classList.remove('active');
                });

                const mainLink = nav.querySelector('.sidebar-link[data-target="' + mainTargetId + '"]');
                if (mainLink) mainLink.classList.add('active');
                
                if (activeLinkElement && activeLinkElement.classList.contains('sub-sidebar-link')) {
                    activeLinkElement.classList.add('active');
                }
            }
            
            if (mobileMenuButton && sidebar) {
                mobileMenuButton.addEventListener('click', function() {
                    sidebar.classList.toggle('-translate-x-full');
                    const isExpanded = !sidebar.classList.contains('-translate-x-full');
                    mobileMenuButton.setAttribute('aria-expanded', isExpanded.toString());
                });
            }

            if (nav) {
                nav.addEventListener('click', function(event) {
                    const link = event.target.closest('.sidebar-link, .sub-sidebar-link');
                    if (link && link.dataset.target) {
                        event.preventDefault(); 
                        const targetId = link.dataset.target;
                        const isSubLink = link.classList.contains('sub-sidebar-link');
                        
                        if (isSubLink) {
                            const parentTargetId = link.dataset.parentTarget; 
                            renderContent(parentTargetId); 
                            setTimeout(() => { 
                                const subTargetElement = document.getElementById(targetId);
                                if (subTargetElement) {
                                    const mobileMenuContainer = document.getElementById('mobile-menu-button-container');
                                    const headerOffset = mobileMenuContainer && window.getComputedStyle(mobileMenuContainer).display !== 'none' ? mobileMenuContainer.offsetHeight : 0;
                                    const elementPosition = subTargetElement.getBoundingClientRect().top;
                                    const offsetPosition = elementPosition + window.pageYOffset - (headerOffset + 16); 
                                    window.scrollTo({ top: offsetPosition, behavior: "smooth" });
                                }
                                const parentSectionElement = mainContentArea.querySelector('#' + parentTargetId + '.content-section');
                                if(parentSectionElement) {
                                    const collapsible = parentSectionElement.querySelector('.section-content-collapsible');
                                    const toggleBtn = parentSectionElement.querySelector('.toggle-content-btn');
                                    if (collapsible && toggleBtn && (collapsible.style.display === 'none' || collapsible.style.display === '')) {
                                        collapsible.style.display = 'block';
                                        toggleBtn.textContent = '内容を閉じる';
                                    }
                                }
                            }, 250); 
                        } else {
                            renderContent(targetId); 
                        }
                        
                        updateActiveLink(targetId); 
                        if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('-translate-x-full')) { 
                            sidebar.classList.add('-translate-x-full');
                            mobileMenuButton.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
            }

            if (audioGuideShortcutLink) {
                audioGuideShortcutLink.addEventListener('click', function(event) {
                    event.preventDefault();
                    renderContent('intro', true); 
                    updateActiveLink('intro');
                    if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('-translate-x-full')) { 
                        sidebar.classList.add('-translate-x-full');
                        mobileMenuButton.setAttribute('aria-expanded', 'false');
                    }
                });
            }
            
            function initializeUI() {
                let initialLoadTargetId = "intro"; 
                if (window.location.hash) {
                    const hashTarget = window.location.hash.substring(1);
                    if (originalSections[hashTarget]) {
                        initialLoadTargetId = hashTarget;
                    }
                } else if (sidebarStructure.length > 0 && sidebarStructure[0].type === 'link' && originalSections[sidebarStructure[0].id] ) {
                     initialLoadTargetId = sidebarStructure[0].id;
                } else if (Object.keys(originalSections).length > 0) { 
                    initialLoadTargetId = Object.keys(originalSections)[0];
                }

                if (originalSections[initialLoadTargetId]) {
                    renderContent(initialLoadTargetId);
                    updateActiveLink(initialLoadTargetId);
                } else if (Object.keys(originalSections).length > 0) { 
                    const firstSectionKey = Object.keys(originalSections)[0];
                    renderContent(firstSectionKey);
                    updateActiveLink(firstSectionKey);
                } else {
                     if (mainContentArea) mainContentArea.innerHTML = "<p class='text-red-500 p-4'>表示できるセクションがありません。</p>";
                }
            }
            
            initializeFirebase(); 


            function openModal(title, definition) {
                if(keywordModal && modalTitle && modalDefinition) {
                    modalTitle.textContent = title + " の解説";
                    modalDefinition.textContent = definition;
                    keywordModal.classList.add('active');
                }
            }

            function closeModal() {
                if(keywordModal) {
                    keywordModal.classList.remove('active');
                }
            }

            if(modalCloseBtn) { modalCloseBtn.addEventListener('click', closeModal); }
            if(keywordModal) {
                keywordModal.addEventListener('click', function(event) { 
                    if (event.target === keywordModal) { closeModal(); }
                });
            }
            
            function attachKeywordButtonListeners(parentElement) {
                if (!parentElement) return;
                parentElement.querySelectorAll('.keyword-btn').forEach(button => {
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);

                    newButton.addEventListener('click', function() {
                        const keyword = this.dataset.keyword;
                        const definition = this.dataset.definition || "このキーワードの解説は準備中です。";
                        const sectionCard = this.closest('.bg-white.p-6.rounded-lg.shadow-lg');
                        if (!sectionCard) return;
                        const contentArea = sectionCard.querySelector('.text-content-for-highlight');
                        if (!contentArea) return;

                        const isCurrentlyActive = this.classList.contains('active-highlight');

                        const allHighlightedSpans = contentArea.querySelectorAll('span.highlight');
                        allHighlightedSpans.forEach(span => {
                            const parent = span.parentNode;
                            if (parent) {
                                while (span.firstChild) {
                                    parent.insertBefore(span.firstChild, span);
                                }
                                parent.removeChild(span);
                                parent.normalize(); 
                            }
                        });

                        sectionCard.querySelectorAll('.keyword-btn.active-highlight').forEach(btn => {
                            btn.classList.remove('active-highlight');
                        });

                        if (!isCurrentlyActive) {
                            this.classList.add('active-highlight');
                            const regex = new RegExp('(' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
                            const walker = document.createTreeWalker(contentArea, NodeFilter.SHOW_TEXT, {
                                acceptNode: function (node) {
                                    if (node.parentNode && (node.parentNode.nodeName === 'SCRIPT' || node.parentNode.nodeName === 'STYLE')) {
                                        return NodeFilter.FILTER_REJECT;
                                    }
                                    let currentNode = node.parentNode;
                                    while(currentNode && currentNode !== contentArea) {
                                        if (currentNode.nodeType === Node.ELEMENT_NODE && currentNode.classList.contains('highlight')) {
                                            return NodeFilter.FILTER_REJECT;
                                        }
                                        currentNode = currentNode.parentNode;
                                    }
                                    return NodeFilter.FILTER_ACCEPT;
                                }
                            }, false);
                            
                            let node;
                            const nodesToModify = []; 
                            while (node = walker.nextNode()) {
                                if (regex.test(node.nodeValue)) {
                                    nodesToModify.push(node);
                                }
                            }

                            nodesToModify.forEach(textNode => {
                                if (!textNode.parentNode) return; 

                                const fragment = document.createDocumentFragment();
                                let lastIndex = 0;
                                textNode.nodeValue.replace(regex, (match, p1, offset) => {
                                    fragment.appendChild(document.createTextNode(textNode.nodeValue.substring(lastIndex, offset)));
                                    const highlightSpan = document.createElement('span');
                                    highlightSpan.className = 'highlight';
                                    highlightSpan.setAttribute('data-keyword', keyword); 
                                    highlightSpan.textContent = p1;
                                    fragment.appendChild(highlightSpan);
                                    lastIndex = offset + match.length;
                                });
                                fragment.appendChild(document.createTextNode(textNode.nodeValue.substring(lastIndex)));
                                textNode.parentNode.replaceChild(fragment, textNode);
                            });
                            openModal(keyword, definition);
                        } else {
                            closeModal();
                        }
                        dataHasUnsavedChanges = true;
                        updateGlobalSaveButtonState();
                    });
                });
            }


            function attachToggleContentButtonListeners(parentElement) {
                if (!parentElement) return;
                parentElement.querySelectorAll('.toggle-content-btn').forEach(button => {
                    const newButton = button.cloneNode(true); 
                    button.parentNode.replaceChild(newButton, button);
                    
                    newButton.addEventListener('click', function() {
                        const sectionCard = this.closest('.bg-white.p-6.rounded-lg.shadow-lg');
                        if (!sectionCard) return;
                        const collapsibleContent = sectionCard.querySelector('.section-content-collapsible');
                        if (!collapsibleContent) return;
                        if (collapsibleContent.style.display === 'none' || collapsibleContent.style.display === '') {
                            collapsibleContent.style.display = 'block'; this.textContent = '内容を閉じる';
                        } else {
                            collapsibleContent.style.display = 'none'; this.textContent = '内容を確認する';
                        }
                        dataHasUnsavedChanges = true;
                        updateGlobalSaveButtonState();
                    });
                });
            }
            function attachActionItemListeners(parentElement) {
                if (!parentElement) return;

                parentElement.querySelectorAll('.action-status-select, .action-notes-input, .deadline-type-select, .deadline-date-input').forEach(input => {
                    let currentElement = input;
                    
                    const handler = function() { 
                        const personIndex = parseInt(this.dataset.personIndex, 10);
                        const actionIndex = parseInt(this.dataset.actionIndex, 10);
                        
                        if (currentActionItemsData && currentActionItemsData[personIndex] && currentActionItemsData[personIndex].actions[actionIndex]) {
                            const itemToUpdate = currentActionItemsData[personIndex].actions[actionIndex];
                            let changed = false;
                            
                            if (this.classList.contains('action-status-select')) {
                                if (itemToUpdate.status !== this.value) { itemToUpdate.status = this.value; changed = true; }
                            } else if (this.classList.contains('action-notes-input')) {
                                if (itemToUpdate.notes !== this.value) { itemToUpdate.notes = this.value; changed = true; }
                            } else if (this.classList.contains('deadline-type-select')) {
                                const dateInput = this.closest('.action-detail-value').querySelector('.deadline-date-input');
                                if (this.value === "日付指定") {
                                    dateInput.style.display = 'block';
                                } else {
                                    dateInput.style.display = 'none';
                                    dateInput.value = ''; 
                                    if (itemToUpdate["期限目安"] !== this.value) { itemToUpdate["期限目安"] = this.value; changed = true; }
                                }
                            } else if (this.classList.contains('deadline-date-input')) {
                                 if (itemToUpdate["期限目安"] !== this.value) { itemToUpdate["期限目安"] = this.value; changed = true; }
                                this.closest('.action-detail-value').querySelector('.deadline-type-select').value = "日付指定";
                            }
                            
                            if (changed) {
                                dataHasUnsavedChanges = true;
                                updateGlobalSaveButtonState();
                                console.log("Action item data updated in memory, unsaved changes: true", itemToUpdate);
                            }
                        } else {
                            console.warn("Action item data not found for index:", personIndex, actionIndex, "Current data:", currentActionItemsData);
                        }
                    };
                    
                    const eventType = currentElement.tagName.toLowerCase() === 'select' ? 'change' : 'input';
                    if (currentElement.eventHandler) { 
                        currentElement.removeEventListener(eventType, currentElement.eventHandler);
                    }
                    currentElement.addEventListener(eventType, handler);
                    currentElement.eventHandler = handler; 
                });
            }
            
            function attachSentenceHighlightListeners(container) {
                if (!container) return;

                const highlightableTextContainers = container.querySelectorAll('.highlightable-text');

                highlightableTextContainers.forEach(block => {
                    if (block.dataset.sentenceListenersProcessed === 'true' && !block.querySelector('.clickable-sentence-part')) {
                        block.dataset.sentenceListenersProcessed = 'false';
                    }

                    if (block.dataset.sentenceListenersProcessed === 'true') {
                        return;
                    }
                    block.dataset.sentenceListenersProcessed = 'true';

                    const walker = document.createTreeWalker(block, NodeFilter.SHOW_TEXT, null, false);
                    let node;
                    const textNodesToProcess = [];
                    while (node = walker.nextNode()) {
                        let parent = node.parentNode;
                        let skip = false;
                        while(parent && parent !== block) {
                            if (parent.classList && (parent.classList.contains('clickable-sentence-part') || parent.classList.contains('highlight'))) {
                                skip = true;
                                break;
                            }
                            parent = parent.parentNode;
                        }
                        if (!skip && node.nodeValue.trim().length > 0) {
                            textNodesToProcess.push(node);
                        }
                    }

                    textNodesToProcess.forEach(textNode => {
                        const text = textNode.nodeValue;
                        const sentences = text.match(/[^。！？]+[。！？]?\s*/g) || [text]; 
                        
                        if (sentences.length > 0 && !(sentences.length === 1 && sentences[0] === textNode.nodeValue)) { 
                            const fragment = document.createDocumentFragment();
                            sentences.forEach((sentenceText, index) => {
                                const span = document.createElement('span');
                                span.textContent = sentenceText;
                                span.style.cursor = 'pointer';
                                span.classList.add('clickable-sentence-part');

                                span.addEventListener('click', function(event) {
                                    event.stopPropagation();
                                    this.classList.toggle('sentence-highlight');
                                    dataHasUnsavedChanges = true;
                                    updateGlobalSaveButtonState();
                                });
                                fragment.appendChild(span);
                            });
                            if (textNode.parentNode) { 
                                textNode.parentNode.replaceChild(fragment, textNode);
                            }
                        }
                    });
                });
            }
            
            if(printPageBtn) {
                printPageBtn.addEventListener('click', function() { window.print(); });
            }
        });
    </script>
</body>
</html>
